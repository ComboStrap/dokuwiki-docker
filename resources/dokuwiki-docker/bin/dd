#!/bin/bash

# The dokuwiki docker command cli and function
dd_echo(){
  echo "DokuWiki Docker: $1"
}






# Clean function
# Adapted from: https://www.dokuwiki.org/tips:maintenance
dd_clean(){

  # Delete file that have not been accessed from 10 days
  find "$DOKU_DOCKER_SAVE_DIR"/cache -type f -atime +10 -delete
  # Delete feed file
  find "$DOKU_DOCKER_SAVE_DIR"/cache -type f -name "*.feed" -delete
  # Remove stale lock files (files which are 1-2 days old)
  find "$DOKU_DOCKER_SAVE_DIR"/locks -name '*.lock' -type f -mtime +1 -delete

  # Purge files older than ${retention_days} days from attic and media_attic (old revisions)
  # Find "$DOKU_DOCKER_SAVE_DIR"/{media_,}attic/ -type f -not -name _dummy -mtime +"${retention_days}" -delete
  # Remove empty directories
  find "$DOKU_DOCKER_SAVE_DIR"/{attic,cache,index,locks,media,media_attic,media_meta,meta,pages,tmp}/ \
        -mindepth 1 -type d -empty -delete

  # Secondary
  echo "DELETE FROM CACHE_LOG WHERE TIMESTAMP > datetime('now', '-5 days');" | sqlite3 "$DOKU_DOCKER_SAVE_DIR"/meta/combo-secondary.sqlite3
  echo "DELETE FROM CACHE_LOG WHERE datetime('now', '-5 days') > timestamp;" | sqlite3 "$DOKU_DOCKER_SAVE_DIR"/meta/combo-secondary.sqlite3
  echo "DELETE FROM REDIRECTIONS_LOG WHERE datetime('now', '-1 days') > timestamp;" | sqlite3 "$DOKU_DOCKER_SAVE_DIR"/meta/combo-secondary.sqlite3
  echo 'VACUUM;' | sqlite3 "$DOKU_DOCKER_SAVE_DIR"/meta/combo-secondary.sqlite3 # get space back

  # Primary
  echo "DELETE FROM REDIRECTIONS_LOG" | sqlite3 "$DOKU_DOCKER_SAVE_DIR"/meta/combo.sqlite3
  echo 'VACUUM;' | sqlite3 "$DOKU_DOCKER_SAVE_DIR"/meta/combo.sqlite3 # get space back
  du -sh  "$DOKU_DOCKER_SAVE_DIR"/meta/combo.sqlite3




}

# Example for a big wiki
# 53M     ./pages
# 285M    ./media
# 2.2G    ./meta
# 5.4M    ./media_meta
# 821M    ./attic
# 15M     ./index
# 1004K   ./locks
# 26M     ./media_attic
# 960K    ./tmp
# 33G     ./cache
# 1.5M    ./log
# 36G     .

dd_data_size(){
  # Size of the sub-directory
  du -h --max-depth=1 "$DOKU_DOCKER_SAVE_DIR"
  # For the directory
  # du -sh .
  # Top 20 files
  # find "$DOKU_DOCKER_SAVE_DIR" -type f -exec du -h {} + | sort -rh | head -n 20
  # find . -type f -exec du -h {} + | sort -rh | head -n 20
}
